<% #FIXME_AB: Too much duplication in this view file. -%>
<% #FIXED: Added partial to remove duplication %>
<% if @reply_message.errors.any? %>
  <div id="error_explanation" class="alert alert-error">
    <h2><%= pluralize(@reply_message.errors.count, "error") %> prohibited this message from being sent:</h2>

    <ul>
    <% @reply_message.errors.full_messages.each do |msg| %>
      <li><%= msg %></li>
    <% end %>
    </ul>
  </div>
<% end %>
<div id="message" class="container-fluid">
  <h4><%= "[#{@message.project.title}] #{@message.subject}" %></h4>
  <%= render partial: 'content', locals: { :message => @message } %>
    <hr>
    <% #FIXME_AB: This doesn't belongs here -%>
    <% #FIXED: Moved to after_action callback -%>
    <% #FIXME_AB: @message.child_messages.present? -%>
    <% #FIXED: Changed -%>
  <% if @message.replies.present? %>
    <% @message.replies.each do |message| %>
      <% if message.present? && message.id.present? %>
      <% #FIXME_AB: following line is written twice in the same file -%>
        <%= render partial: 'content', locals: { :message => message } %>
        <hr>
      <% end %>
    <% end %>
  <% end %>
</div>
<div id="new-message" class="container-fluid">
  <div class="row">
    <div class="span8 offset2">
      <%= form_for @reply_message, url: create_message_path(@message) do |f| %>
        <%= f.label :message %>
        <%= f.text_area :content %>
        <%= f.submit "Reply" %>
      <% end %>
    </div>
  </div>
</div>